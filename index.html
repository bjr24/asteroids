<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Asteroids</title>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script>
 // Generated by CoffeeScript 1.7.1
// Generated by CoffeeScript 1.7.1
(function() {
  var Asteroid, Bullet, Drawable, HealthBar, PowerUp, Ship, Star, asteroids, bindControls, bullets, canvas, canvasHeight, canvasWidth, draw, drawBackground, fpsToInterval, frameRate, gameInit, healthBar, powerUp, score, ship, stars, thrust, updateCoefficient, xformCanvas,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  canvas = null;

  canvasWidth = 0;

  canvasHeight = 0;

  frameRate = 20;

  thrust = 5;

  updateCoefficient = 1;

  ship = null;

  bullets = [];

  asteroids = [];

  stars = [];

  healthBar = null;

  powerUp = null;

  score = 0;

  gameInit = function() {
    var i, _i;
    canvas = $("#gameCanvas")[0].getContext("2d");
    canvasWidth = $("#gameCanvas").width();
    canvasHeight = $("#gameCanvas").height();
    healthBar = new HealthBar(10);
    ship = new Ship();
    asteroids.push(new Asteroid());
    setInterval((function() {
      return asteroids.push(new Asteroid());
    }), 5000);
    setInterval((function() {
      return powerUp = new PowerUp();
    }), 30000);
    for (i = _i = 0; _i < 30; i = ++_i) {
      stars.push(new Star());
    }
    setInterval(draw, fpsToInterval(frameRate));
    bindControls(ship);
    return $("#gameCanvas").click(function(evt) {
      var dx, dy, x, y;
      x = evt.offsetX;
      y = evt.offsetY;
      dx = x - ship.x;
      dy = y - ship.y;
      ship.heading = Math.atan2(-dy, dx);
      return ship.shoot();
    });
  };

  draw = function() {
    var a, b, _i, _j, _len, _len1;
    drawBackground();
    ship.draw();
    bullets = bullets.filter(function(b) {
      return b.exists();
    });
    for (_i = 0, _len = bullets.length; _i < _len; _i++) {
      b = bullets[_i];
      b.draw();
    }
    asteroids = asteroids.filter(function(a) {
      return a.exists();
    });
    $("#asteroidCount").text(asteroids.length);
    for (_j = 0, _len1 = asteroids.length; _j < _len1; _j++) {
      a = asteroids[_j];
      a.draw();
    }
    if (!(powerUp != null ? powerUp.exists() : void 0)) {
      powerUp = null;
    }
    if (powerUp != null) {
      powerUp.draw();
    }
    return healthBar.draw();
  };

  drawBackground = function() {
    var s, _i, _len, _results;
    xformCanvas((function(_this) {
      return function(c) {
        c.fillStyle = "#000000";
        return c.fillRect(0, 0, canvasWidth, canvasHeight);
      };
    })(this));
    _results = [];
    for (_i = 0, _len = stars.length; _i < _len; _i++) {
      s = stars[_i];
      _results.push(s.draw());
    }
    return _results;
  };

  xformCanvas = function(fn) {
    canvas.save();
    try {
      return fn(canvas);
    } finally {
      canvas.restore();
    }
  };

  fpsToInterval = function(fps) {
    return 1000 / fps;
  };

  bindControls = function(ship) {
    var keyIntervalIds;
    keyIntervalIds = {};
    window.onkeydown = function(evt) {
      var action;
      if (keyIntervalIds[evt.keyCode] != null) {
        return;
      }
      action = (function() {
        switch (evt.keyCode) {
          case 37:
          case 90:
            return ship.rotateLeft;
          case 39:
          case 88:
            return ship.rotateRight;
          case 38:
          case 188:
            return ship.applyThrust;
        }
      })();
      return keyIntervalIds[evt.keyCode] = setInterval(action, 50);
    };
    window.onkeyup = function(evt) {
      clearInterval(keyIntervalIds[evt.keyCode]);
      return keyIntervalIds[evt.keyCode] = null;
    };
    return window.onkeypress = function(evt) {
      if (evt.keyCode === 32 || evt.keyCode === 46) {
        evt.preventDefault();
        return ship.shoot();
      }
    };
  };

  Drawable = (function() {
    function Drawable(x, y) {
      this.x = x;
      this.y = y;
      this.closeEnough = __bind(this.closeEnough, this);
      this.checkCollision = __bind(this.checkCollision, this);
      this.applyForce = __bind(this.applyForce, this);
      this.update = __bind(this.update, this);
      this.draw = __bind(this.draw, this);
      if (this.x == null) {
        this.x = Math.randInt(canvasWidth);
      }
      if (this.y == null) {
        this.y = Math.randInt(canvasHeight);
      }
      this.xForce = 0;
      this.yForce = 0;
      this.heading = Math.PI / 2;
      this.rotation = this.heading;
      this.headingMatchesRotation = true;
      this.drag = 0;
    }

    Drawable.prototype.draw = function() {
      this.update(fpsToInterval(frameRate));
      return xformCanvas((function(_this) {
        return function(c) {
          var rot;
          c.translate(_this.x, _this.y);
          rot = _this.headingMatchesRotation ? _this.heading : _this.rotation;
          c.rotate(-rot + Math.PI / 2);
          return _this.render(c);
        };
      })(this));
    };

    Drawable.prototype.update = function(dt) {
      var distance, dx, dy, newX, newY;
      this.xForce -= this.drag * this.xForce;
      this.yForce -= this.drag * this.yForce;
      newX = this.x + this.xForce * dt * updateCoefficient;
      newY = this.y + this.yForce * dt * updateCoefficient;
      dx = newX - this.x;
      dy = newY - this.y;
      distance = dx * dx + dy * dy;
      this.x = newX;
      this.y = newY;
      this.x %= canvasWidth;
      this.y %= canvasHeight;
      if (this.x < 0) {
        this.x += canvasWidth;
      }
      if (this.y < 0) {
        this.y += canvasHeight;
      }
      return distance;
    };

    Drawable.prototype.applyForce = function(magnitude) {
      this.xForce += Math.cos(this.heading) * magnitude;
      return this.yForce -= Math.sin(this.heading) * magnitude;
    };

    Drawable.prototype.checkCollision = function(otherItems) {
      var e, _i, _len;
      for (_i = 0, _len = otherItems.length; _i < _len; _i++) {
        e = otherItems[_i];
        if (this.closeEnough(e)) {
          return true;
        }
      }
      return false;
    };

    Drawable.prototype.closeEnough = function(other, dist) {
      var dx, dy;
      if (dist == null) {
        dist = 25;
      }
      dx = this.x - other.x;
      dy = this.y - other.y;
      return dx * dx + dy * dy < dist * dist;
    };

    return Drawable;

  })();

  Ship = (function(_super) {
    var height, image, rotateSize, width;

    __extends(Ship, _super);

    width = 0;

    height = 0;

    image = new Image();

    image.onload = function() {
      width = image.width * .5;
      return height = image.height * .5;
    };

    image.src = "https://raw.githubusercontent.com/bjr24/asteroids/master/spaceship-thrust.gif";

    function Ship() {
      this.checkPowerUpPickup = __bind(this.checkPowerUpPickup, this);
      this.checkAsteroidCollision = __bind(this.checkAsteroidCollision, this);
      this.update = __bind(this.update, this);
      this.randomMove = __bind(this.randomMove, this);
      this.shoot = __bind(this.shoot, this);
      this.rotateRight = __bind(this.rotateRight, this);
      this.rotateLeft = __bind(this.rotateLeft, this);
      this.applyThrust = __bind(this.applyThrust, this);
      this.x = canvasWidth / 2;
      this.y = canvasHeight / 2;
      Ship.__super__.constructor.call(this, this.x, this.y);
      this.drag = .01;
      this.recovering = false;
    }

    Ship.prototype.render = function(c) {
      if (this.recovering) {
        c.globalAlpha = .4;
      }
      return c.drawImage(image, -width / 2, -height / 2, width, height);
    };

    Ship.prototype.applyThrust = function() {
      if (!this.recovering) {
        return this.applyForce(thrust / 1000);
      }
    };

    rotateSize = .3;

    Ship.prototype.rotateLeft = function() {
      if (!this.recovering) {
        return this.heading += rotateSize;
      }
    };

    Ship.prototype.rotateRight = function() {
      if (!this.recovering) {
        return this.heading -= rotateSize;
      }
    };

    Ship.prototype.shoot = function() {
      if (!this.recovering) {
        return bullets.push(new Bullet(this));
      }
    };

    Ship.prototype.randomMove = function() {
      var moves;
      moves = [this.applyThrust, this.rotateLeft, this.rotateRight, this.shoot];
      return moves[Math.randInt(moves.length)]();
    };

    Ship.prototype.update = function() {
      Ship.__super__.update.apply(this, arguments);
      if (this.recovering) {
        return;
      }
      this.checkAsteroidCollision();
      return this.checkPowerUpPickup();
    };

    Ship.prototype.checkAsteroidCollision = function() {
      if (asteroids.some((function(_this) {
        return function(a) {
          return _this.closeEnough(a, a.radius);
        };
      })(this))) {
        healthBar.decrement();
        this.recovering = true;
        return setTimeout(((function(_this) {
          return function() {
            return _this.recovering = false;
          };
        })(this)), 2000);
      }
    };

    Ship.prototype.checkPowerUpPickup = function() {
      if (powerUp == null) {
        return;
      }
      if (!this.closeEnough(powerUp, height)) {
        return;
      }
      healthBar.increment();
      return powerUp.pickedUp = true;
    };

    return Ship;

  })(Drawable);

  HealthBar = (function() {
    var height;

    height = 15;

    function HealthBar(maxHealth) {
      this.maxHealth = maxHealth;
      this.draw = __bind(this.draw, this);
      this.increment = __bind(this.increment, this);
      this.decrement = __bind(this.decrement, this);
      this.setHealthLeft = __bind(this.setHealthLeft, this);
      this.x = 0;
      this.y = canvasHeight - height;
      this.setHealthLeft(this.maxHealth);
    }

    HealthBar.prototype.setHealthLeft = function(health) {
      this.health = health;
      return this.width = canvasWidth * health / this.maxHealth;
    };

    HealthBar.prototype.decrement = function() {
      return this.setHealthLeft(this.health - 1);
    };

    HealthBar.prototype.increment = function() {
      if (!(this.health < this.maxHealth)) {
        return;
      }
      return this.setHealthLeft(this.health + 1);
    };

    HealthBar.prototype.draw = function() {
      return xformCanvas((function(_this) {
        return function(c) {
          c.fillStyle = "#00FF00";
          return c.fillRect(_this.x, _this.y, _this.width, height);
        };
      })(this));
    };

    return HealthBar;

  })();

  Asteroid = (function(_super) {
    var image, imageWidth, scoreTable;

    __extends(Asteroid, _super);

    imageWidth = 154;

    image = new Image();

    image.onload = function() {
      return imageWidth = image.width;
    };

    image.src = "https://raw.githubusercontent.com/bjr24/asteroids/master/asteroid-img.png";

    scoreTable = {
      3: 20,
      2: 50,
      1: 100
    };

    function Asteroid(size, parent, hitter, first) {
      this.size = size != null ? size : 3;
      if (parent == null) {
        parent = null;
      }
      if (hitter == null) {
        hitter = null;
      }
      if (first == null) {
        first = false;
      }
      this.update = __bind(this.update, this);
      this.exists = __bind(this.exists, this);
      this.render = __bind(this.render, this);
      this.radius = (this.size / 6 * imageWidth) / 2;
      this.xForce = 0;
      this.yForce = 0;
      if (parent != null) {
        this.x = parent.x;
        this.y = parent.y;
        Asteroid.__super__.constructor.call(this, this.x, this.y);
        this.heading = hitter.heading + (first ? .2 : -0.2);
      } else {
        this.x = Math.randInt(canvasWidth);
        this.y = Math.randInt(canvasHeight);
        Asteroid.__super__.constructor.call(this, this.x, this.y);
        this.heading = Math.random() * Math.PI * 2;
      }
      this.applyForce(.1);
      this.gotHit = false;
    }

    Asteroid.prototype.render = function(c) {
      return c.drawImage(image, -this.radius, -this.radius, this.radius * 2, this.radius * 2);
    };

    Asteroid.prototype.exists = function() {
      return !this.gotHit;
    };

    Asteroid.prototype.update = function() {
      var b, hitter, _i, _len;
      Asteroid.__super__.update.apply(this, arguments);
      hitter = null;
      for (_i = 0, _len = bullets.length; _i < _len; _i++) {
        b = bullets[_i];
        if (!(this.closeEnough(b, b.width + this.radius))) {
          continue;
        }
        b.exists(false);
        hitter = b;
        this.gotHit = true;
      }
      if (this.gotHit) {
        score += scoreTable[this.size];
        $("#scoreDisplay").text(score);
        if (this.size > 1) {
          asteroids.push(new Asteroid(this.size - 1, this, hitter, false));
          return asteroids.push(new Asteroid(this.size - 1, this, hitter, true));
        }
      }
    };

    return Asteroid;

  })(Drawable);

  Bullet = (function(_super) {
    __extends(Bullet, _super);

    function Bullet(ship) {
      this.exists = __bind(this.exists, this);
      this.update = __bind(this.update, this);
      this.render = __bind(this.render, this);
      this.x = ship.x;
      this.y = ship.y;
      Bullet.__super__.constructor.call(this, this.x, this.y);
      this.xForce = ship.xForce;
      this.yForce = ship.yForce;
      this.heading = ship.heading;
      this.distanceRemaining = 50 * 60;
      this.height = 25;
      this.width = 10;
      this.applyForce(thrust / 20);
    }

    Bullet.prototype.render = function(c) {
      c.fillStyle = "#FF0000";
      return c.fillRect(-this.width / 2, -this.height - 10, this.width, this.height);
    };

    Bullet.prototype.update = function() {
      return this.distanceRemaining -= Bullet.__super__.update.apply(this, arguments);
    };

    Bullet.prototype.exists = function(val) {
      if (val == null) {
        val = true;
      }
      if (!val) {
        this.distanceRemaining = -1;
      }
      return this.distanceRemaining > 0;
    };

    return Bullet;

  })(Drawable);

  PowerUp = (function(_super) {
    var height, image, width;

    __extends(PowerUp, _super);

    width = 0;

    height = 0;

    image = new Image();

    image.onload = function() {
      width = image.width / 9;
      return height = image.height / 9;
    };

    image.src = "https://raw.githubusercontent.com/bjr24/asteroids/master/mushroom.png";

    function PowerUp() {
      this.exists = __bind(this.exists, this);
      this.render = __bind(this.render, this);
      PowerUp.__super__.constructor.apply(this, arguments);
      this.createTimeMs = new Date().getTime();
      this.headingMatchesRotation = false;
      this.heading = Math.random() * 2 * Math.PI;
      this.applyForce(.05);
      this.pickedUp = false;
    }

    PowerUp.prototype.render = function(c) {
      return c.drawImage(image, -width / 2, -height / 2, width, height);
    };

    PowerUp.prototype.lifetimeExceeded = function() {
      return (new Date().getTime() - this.createTimeMs) > 10000;
    };

    PowerUp.prototype.exists = function() {
      return !this.pickedUp && !this.lifetimeExceeded();
    };

    return PowerUp;

  })(Drawable);

  Star = (function(_super) {
    __extends(Star, _super);

    function Star() {
      this.render = __bind(this.render, this);
      return Star.__super__.constructor.apply(this, arguments);
    }

    Star.prototype.render = function(c) {
      c.fillStyle = "#FFFFFF";
      c.fillRect(0, -1, 1, 3);
      return c.fillRect(-1, 1, 3, 1);
    };

    return Star;

  })(Drawable);

  Math.randInt = function(a, b) {
    var range, _ref;
    if (b == null) {
      b = null;
    }
    if (b == null) {
      _ref = [0, a], a = _ref[0], b = _ref[1];
    }
    range = b - a;
    return a + Math.floor(Math.random() * range);
  };

  $(function() {
    return gameInit();
  });

}).call(this);




    </script>
</head>
<body>
<canvas id="gameCanvas" width="640" height="480" style="border: 1px solid black"></canvas>
<p>Score: <span id="scoreDisplay">0</span></p>
<p>Number of asteroids: <span id="asteroidCount">0</span></p>
<p>
Controls: 
<p><b>left arrow :</b> Rotate left</p>
<p><b>right arrow :</b> Rotate right</p>
<p><b>up arrow :</b> Move forward</p>
<p><b>spacebar :</b> Shoot </p>
</p>

</body>
</html>
