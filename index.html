<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Asteroids</title>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script>
      // Generated by CoffeeScript 1.7.1
(function() {
  var Asteroid, Bullet, Drawable, Ship, asteroids, bindControls, bullets, canvas, canvasHeight, canvasWidth, draw, fpsToInterval, frameRate, gameInit, imageScaleScaleFactor, ship, thrust, updateCoefficient,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  canvas = null;

  canvasWidth = 0;

  canvasHeight = 0;

  imageScaleScaleFactor = .5;

  frameRate = 20;

  thrust = 5;

  updateCoefficient = 1;

  ship = null;

  bullets = [];

  asteroids = [];

  gameInit = function() {
    canvas = $("#gameCanvas")[0].getContext("2d");
    canvasWidth = $("#gameCanvas").width();
    canvasHeight = $("#gameCanvas").height();
    ship = new Ship();
    asteroids.push(new Asteroid());
    setInterval((function() {
      return asteroids.push(new Asteroid());
    }), 5000);
    setInterval(draw, fpsToInterval(frameRate));
    return bindControls(ship);
  };

  draw = function() {
    var a, b, _i, _j, _len, _len1, _results;
    canvas.clearRect(0, 0, canvasWidth, canvasHeight);
    ship.draw();
    bullets = bullets.filter(function(b) {
      return b.exists();
    });
    for (_i = 0, _len = bullets.length; _i < _len; _i++) {
      b = bullets[_i];
      b.draw();
    }
    asteroids = asteroids.filter(function(a) {
      return a.exists();
    });
    _results = [];
    for (_j = 0, _len1 = asteroids.length; _j < _len1; _j++) {
      a = asteroids[_j];
      _results.push(a.draw());
    }
    return _results;
  };

  fpsToInterval = function(fps) {
    return 1000 / fps;
  };

  bindControls = function(ship) {
    var keyIntervalIds;
    keyIntervalIds = {};
    window.onkeydown = function(evt) {
      var action;
      if (keyIntervalIds[evt.keyCode] != null) {
        return;
      }
      action = (function() {
        switch (evt.keyCode) {
          case 90:
            return ship.rotateLeft;
          case 88:
            return ship.rotateRight;
          case 188:
            return ship.applyThrust;
        }
      })();
      return keyIntervalIds[evt.keyCode] = setInterval(action, 50);
    };
    window.onkeyup = function(evt) {
      clearInterval(keyIntervalIds[evt.keyCode]);
      return keyIntervalIds[evt.keyCode] = null;
    };
    return window.onkeypress = function(evt) {
      if (evt.charCode === 46) {
        return ship.shoot();
      }
    };
  };

  Drawable = (function() {
    function Drawable() {
      this.closeEnough = __bind(this.closeEnough, this);
      this.checkCollision = __bind(this.checkCollision, this);
      this.loadImage = __bind(this.loadImage, this);
      this.applyForce = __bind(this.applyForce, this);
      this.update = __bind(this.update, this);
      this.draw = __bind(this.draw, this);
    }

    Drawable.prototype.draw = function() {
      this.update(fpsToInterval(frameRate));
      canvas.save();
      canvas.translate(this.x, this.y);
      canvas.rotate(-this.heading + Math.PI / 2);
      this.render();
      return canvas.restore();
    };

    Drawable.prototype.update = function(dt) {
      var distance, dx, dy, newX, newY;
      newX = this.x + this.xForce * dt * updateCoefficient;
      newY = this.y + this.yForce * dt * updateCoefficient;
      dx = newX - this.x;
      dy = newY - this.y;
      distance = dx * dx + dy * dy;
      this.x = newX;
      this.y = newY;
      this.x %= canvasWidth;
      this.y %= canvasHeight;
      if (this.x < 0) {
        this.x += canvasWidth;
      }
      if (this.y < 0) {
        this.y += canvasHeight;
      }
      return distance;
    };

    Drawable.prototype.applyForce = function(magnitude) {
      this.xForce += Math.cos(this.heading) * magnitude;
      return this.yForce -= Math.sin(this.heading) * magnitude;
    };

    Drawable.prototype.loadImage = function(src, scale) {
      var image;
      if (scale == null) {
        scale = imageScaleScaleFactor;
      }
      image = new Image();
      image.onload = (function(_this) {
        return function() {
          _this.width = image.width * scale;
          _this.height = image.height * scale;
          return _this.drawImage = function() {
            return canvas.drawImage(image, -_this.width / 2, -_this.height / 2, _this.width, _this.height);
          };
        };
      })(this);
      return image.src = src;
    };

    Drawable.prototype.checkCollision = function(otherItems) {
      var e, _i, _len;
      for (_i = 0, _len = otherItems.length; _i < _len; _i++) {
        e = otherItems[_i];
        if (this.closeEnough(e)) {
          return true;
        }
      }
      return false;
    };

    Drawable.prototype.closeEnough = function(other, distSquared) {
      var dx, dy;
      if (distSquared == null) {
        distSquared = 600;
      }
      dx = this.x - other.x;
      dy = this.y - other.y;
      return dx * dx + dy * dy < distSquared;
    };

    return Drawable;

  })();

  Ship = (function(_super) {
    var rotateSize;

    __extends(Ship, _super);

    function Ship() {
      this.randomMove = __bind(this.randomMove, this);
      this.shoot = __bind(this.shoot, this);
      this.rotateRight = __bind(this.rotateRight, this);
      this.rotateLeft = __bind(this.rotateLeft, this);
      this.applyThrust = __bind(this.applyThrust, this);
      this.render = __bind(this.render, this);
      this.setInitialPosition = __bind(this.setInitialPosition, this);
      var image;
      this.width = 0;
      this.length = 0;
      image = new Image();
      image.onload = (function(_this) {
        return function() {
          _this.width = image.width * imageScaleScaleFactor;
          _this.height = image.height * imageScaleScaleFactor;
          return _this.drawImage = function() {
            return canvas.drawImage(image, -_this.width / 2, -_this.height / 2, _this.width, _this.height);
          };
        };
      })(this);
      image.src = "spaceship.gif";
      this.setInitialPosition();
    }

    Ship.prototype.setInitialPosition = function() {
      this.x = canvasWidth / 2;
      this.y = canvasHeight / 2;
      this.xForce = 0;
      this.yForce = 0;
      return this.heading = Math.PI / 2;
    };

    Ship.prototype.render = function() {
      return this.drawImage();
    };

    Ship.prototype.applyThrust = function() {
      return this.applyForce(thrust / 1000);
    };

    rotateSize = .3;

    Ship.prototype.rotateLeft = function() {
      return this.heading += rotateSize;
    };

    Ship.prototype.rotateRight = function() {
      return this.heading -= rotateSize;
    };

    Ship.prototype.shoot = function() {
      return bullets.push(new Bullet(this));
    };

    Ship.prototype.randomMove = function() {
      var moves;
      moves = [this.applyThrust, this.rotateLeft, this.rotateRight, this.shoot];
      return moves[Math.randInt(moves.length)]();
    };

    return Ship;

  })(Drawable);

  Asteroid = (function(_super) {
    var image;

    __extends(Asteroid, _super);

    image = new Image();

    image.onload = function() {
      return Asteroid.drawImage = function(scaling) {
        return canvas.drawImage(image, -Asteroid.width / 2, -Asteroid.height / 2, Asteroid.width, Asteroid.height);
      };
    };

    image.src = "asteroid-img.png";

    function Asteroid(size, parent, first) {
      this.size = size != null ? size : 2;
      if (parent == null) {
        parent = null;
      }
      if (first == null) {
        first = false;
      }
      this.update = __bind(this.update, this);
      this.exists = __bind(this.exists, this);
      this.render = __bind(this.render, this);
      this.width = this.size / 4 * image.width;
      this.height = this.size / 4 * image.height;
      this.length = this.height;
      this.xForce = 0;
      this.yForce = 0;
      this.loadImage("asteroid-img.png", this.size / 4);
      if ((parent != null)) {
        this.x = parent.x;
        this.y = parent.y;
        this.heading = parent.heading + (first ? .2 : -0.2);
      } else {
        this.x = Math.randInt(canvasWidth);
        this.y = Math.randInt(canvasHeight);
        this.heading = Math.random() * Math.PI * 2;
      }
      this.applyForce(.1);
      this.gotHit = false;
    }

    Asteroid.prototype.render = function() {
      return this.drawImage();
    };

    Asteroid.prototype.exists = function() {
      return !this.gotHit;
    };

    Asteroid.prototype.update = function(dt) {
      var b, _i, _len;
      Asteroid.__super__.update.call(this, dt);
      for (_i = 0, _len = bullets.length; _i < _len; _i++) {
        b = bullets[_i];
        if (!(this.closeEnough(b))) {
          continue;
        }
        b.exists(false);
        this.gotHit = true;
      }
      if (this.gotHit && this.size > 1) {
        asteroids.push(new Asteroid(1, this, false));
        return asteroids.push(new Asteroid(1, this, true));
      }
    };

    return Asteroid;

  })(Drawable);

  Bullet = (function(_super) {
    __extends(Bullet, _super);

    function Bullet(ship) {
      this.exists = __bind(this.exists, this);
      this.update = __bind(this.update, this);
      this.render = __bind(this.render, this);
      this.x = ship.x;
      this.y = ship.y;
      this.xForce = ship.xForce;
      this.yForce = ship.yForce;
      this.heading = ship.heading;
      this.distanceRemaining = 50 * 60;
      this.length = 25;
      this.width = 10;
      this.applyForce(thrust / 20);
    }

    Bullet.prototype.render = function() {
      canvas.fillStyle = "#FF0000";
      return canvas.fillRect(-this.width / 2, -this.length - 10, this.width, this.length);
    };

    Bullet.prototype.update = function(dt) {
      return this.distanceRemaining -= Bullet.__super__.update.apply(this, arguments);
    };

    Bullet.prototype.exists = function(val) {
      if (val == null) {
        val = true;
      }
      if (!val) {
        this.distanceRemaining = -1;
      }
      return this.distanceRemaining > 0;
    };

    return Bullet;

  })(Drawable);

  Math.randInt = function(a, b) {
    var range, _ref;
    if (b == null) {
      b = null;
    }
    if (b == null) {
      _ref = [0, a], a = _ref[0], b = _ref[1];
    }
    range = b - a;
    return a + Math.floor(Math.random() * range);
  };

  $(function() {
    return gameInit();
  });

}).call(this);

//# sourceMappingURL=asteroids.map

    </script>
</head>
<body>
<canvas id="gameCanvas" width="640" height="480" style="border: 1px solid black"></canvas>
</body>
</html>
